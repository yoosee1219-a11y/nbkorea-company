rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Partners collection (기존 규칙 유지)
    match /partners/{partnerId} {
      allow read: if true;  // 누구나 조회 가능
      allow write: if request.auth != null;  // 인증된 사용자만 수정 가능
    }

    // Blog posts collection (기존 규칙 유지)
    match /blog_posts/{postId} {
      allow read: if true;  // 누구나 조회 가능
      allow write: if request.auth != null;  // 인증된 사용자만 수정 가능
    }

    // Consultations collection (새로 추가)
    match /consultations/{consultationId} {
      // 누구나 상담 신청 가능 (privacy_consent가 true일 때만)
      allow create: if request.resource.data.privacy_consent == true
                    && request.resource.data.consultation_type is string
                    && request.resource.data.form_data is map;

      // 인증된 관리자만 조회/수정/삭제 가능
      allow read, update, delete: if request.auth != null;
    }

    // Admins collection (기존 규칙 유지)
    match /admins/{adminId} {
      allow read, write: if request.auth != null;
    }

    // Settings collection (폼 설정 등)
    match /settings/{settingId} {
      allow read: if true;  // 누구나 조회 가능 (고객 폼에서 사용)
      allow write: if request.auth != null;  // 인증된 관리자만 수정 가능
    }

    // Influencers collection (인플루언서 관리)
    match /influencers/{influencerId} {
      allow read: if true;  // 누구나 조회 가능 (리퍼럴 코드 검증용)
      allow create, update, delete: if request.auth != null;  // 인증된 관리자만 생성/수정/삭제 가능
    }

    // Referral visits collection (리퍼럴 방문 트래킹)
    match /referral_visits/{visitId} {
      allow create: if true;  // 누구나 방문 기록 가능
      allow read: if request.auth != null;  // 인증된 관리자만 조회 가능
      allow update, delete: if false;  // 수정/삭제 불가 (통계 무결성 보장)
    }
  }
}
